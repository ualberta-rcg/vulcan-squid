# Squid Proxy DaemonSet - Deploys one Squid instance per node using host networking
# This provides stable IP addresses for CVMFS and other services that need consistent endpoints
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: squid
  namespace: proxy
spec:
  selector:
    matchLabels:
      app: squid
  template:
    metadata:
      labels:
        app: squid
    spec:
      # Use host networking for stable IP addresses
      hostNetwork: true
      dnsPolicy: ClusterFirstWithHostNet
      
      containers:
        - name: squid
          image: ubuntu/squid:latest
          imagePullPolicy: Always
          
          # Environment variables for node identification
          env:
            - name: NODE_NAME
              valueFrom:
                fieldRef:
                  apiVersion: v1
                  fieldPath: spec.nodeName
            - name: MY_POD_IP
              valueFrom:
                fieldRef:
                  apiVersion: v1
                  fieldPath: status.podIP
            - name: SERVICE_DNS
              value: squid-peers.proxy.svc.cluster.local
          
          # Ports exposed on host network
          ports:
            - containerPort: 31234
              name: http-proxy
              protocol: TCP
            - containerPort: 31235
              name: icp
              protocol: TCP
          
          # Security context - hardened for production
          securityContext:
            allowPrivilegeEscalation: false
            privileged: false
            readOnlyRootFilesystem: true
            runAsNonRoot: true
            runAsUser: 3128  # Squid user ID
            runAsGroup: 3128 # Squid group ID
            capabilities:
              drop:
                - ALL
              add:
                - NET_BIND_SERVICE  # Required for binding to privileged ports
            seccompProfile:
              type: RuntimeDefault
          
          # Resource limits for HPC cluster workload
          resources:
            requests:
              memory: "8Gi"      # 8GB minimum for CVMFS caching
              cpu: "1000m"       # 1 CPU core minimum
            limits:
              memory: "32Gi"     # 32GB maximum (adjust based on node memory)
              cpu: "4000m"       # 4 CPU cores maximum
          
          # Volume mounts for configuration and cache
          volumeMounts:
            - mountPath: /etc/squid/whitelist.txt
              name: squid-whitelist
              subPath: whitelist.txt
              readOnly: true
            - mountPath: /etc/squid/conf.d/01-whitelist.conf
              name: squid-whitelist
              subPath: whitelist.conf
              readOnly: true
            - mountPath: /cache
              name: cache-dir
            - mountPath: /etc/squid/conf.d/02-cache.conf
              name: cache-config
              subPath: cache.conf
              readOnly: true
            - mountPath: /etc/squid/squid.conf
              name: entrypoint
              subPath: squid.conf
              readOnly: true
            - mountPath: /var/spool/squid
              name: squid-spool
            - mountPath: /var/log/squid
              name: squid-logs
            - mountPath: /tmp
              name: squid-tmp
            - mountPath: /opt/peer-discovery.sh
              name: entrypoint
              subPath: peer-discovery.sh

          command:
            - /bin/sh
            - '-c'
            - |
              /bin/sh /opt/peer-discovery.sh &
              exec entrypoint.sh -f /etc/squid/squid.conf -NYC
      
      # Pod configuration
      restartPolicy: Always
      terminationGracePeriodSeconds: 30
      
      # Pod security context
      securityContext:
        fsGroup: 3128
        runAsNonRoot: true
        runAsUser: 3128
        runAsGroup: 3128
        seccompProfile:
          type: RuntimeDefault
      
      # Volumes for configuration and persistent cache
      volumes:
        - name: squid-whitelist
          configMap:
            name: squid-whitelist
            defaultMode: 420
        - name: cache-config
          configMap:
            name: cache-config
            defaultMode: 420
        - name: cache-dir
          hostPath:
            path: /var/lib/squid
            type: DirectoryOrCreate
        - name: entrypoint
          configMap:
            name: entrypoint
            defaultMode: 493
        - name: squid-spool
          hostPath:
            path: /var/lib/squid/spool
            type: DirectoryOrCreate
        - name: squid-logs
          hostPath:
            path: /var/lib/squid/logs
            type: DirectoryOrCreate
        - name: squid-tmp
          emptyDir:
            sizeLimit: 1Gi
  
  # Rolling update strategy for zero-downtime updates
  updateStrategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 0
      maxUnavailable: 1