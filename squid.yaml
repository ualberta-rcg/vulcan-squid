apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: squid
  namespace: proxy
spec:
  selector:
    matchLabels:
      app: squid
  template:
    metadata:
      labels:
        app: squid
    spec:
      hostNetwork: true
      dnsPolicy: ClusterFirstWithHostNet
      containers:
        - env:
            - name: NODE_NAME
              valueFrom:
                fieldRef:
                  apiVersion: v1
                  fieldPath: spec.nodeName
            - name: MY_POD_IP
              valueFrom:
                fieldRef:
                  apiVersion: v1
                  fieldPath: status.podIP
          image: ubuntu/squid:5.2-22.04_beta
          imagePullPolicy: Always
          name: squid
          ports:
            - containerPort: 3128
              name: squid
              protocol: TCP
            - containerPort: 3130
              name: icp
              protocol: TCP
          resources: {}
          securityContext:
            allowPrivilegeEscalation: false
            privileged: false
            readOnlyRootFilesystem: false
            runAsNonRoot: false
          terminationMessagePath: /dev/termination-log
          terminationMessagePolicy: File
          volumeMounts:
            - mountPath: /etc/squid/whitelist.txt
              name: squid-whitelist
              subPath: whitelist.txt
            - mountPath: /etc/squid/conf.d/01-whitelist.conf
              name: squid-whitelist
              subPath: whitelist.conf
            - mountPath: /cache
              name: cache-dir
            - mountPath: /etc/squid/conf.d/02-cache.conf
              name: cache-config
              subPath: cache.conf
            - mountPath: /etc/squid/squid.conf
              name: entrypoint
              subPath: squid.conf
      restartPolicy: Always
      schedulerName: default-scheduler
      securityContext: {}
      terminationGracePeriodSeconds: 30
      volumes:
        - configMap:
            defaultMode: 420
            name: squid-whitelist
            optional: false
          name: squid-whitelist
        - configMap:
            defaultMode: 420
            name: cache-config
            optional: false
          name: cache-config
        - hostPath:
            path: /var/lib/squid
            type: ''
          name: cache-dir
        - configMap:
            defaultMode: 493
            name: entrypoint
          name: entrypoint
  updateStrategy:
    rollingUpdate:
      maxSurge: 0
      maxUnavailable: 1
    type: RollingUpdate